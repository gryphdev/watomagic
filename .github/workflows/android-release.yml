name: Watomagic Android Release Build

on:
  # Trigger manually from Actions tab
  workflow_dispatch:
  # Only trigger on version tags (v*) - creates GitHub Release automatically
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # ‚úÖ Required to create releases and upload assets
  actions: read

env:
  JAVA_VERSION: '17'
  GRADLE_VERSION: '8.12'
  PACKAGE_NAME: 'com.parishod.watomagic'
  BASE_VERSION_CODE: 10000

jobs:
  build-release:
    name: üì± Build Signed Android Release APK
    runs-on: ubuntu-latest  # ‚úÖ Linux is faster, free for public repos, and better for Android builds
    timeout-minutes: 60
    environment: watomagic  # ‚úÖ Uses environment secrets from "watomagic" environment

    steps:
      # ============================================================
      # STEP 1: Checkout repository
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version detection

      # ============================================================
      # STEP 2: Verify signing secrets (EARLY - before heavy setup)
      # ============================================================
      - name: Verify signing secrets
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "üîê Verifying signing secrets (early check)..."
          echo ""
          echo "üîç Debugging secret access:"
          echo "   - Workflow environment: ${{ job.environment || 'None (using repository secrets)' }}"
          echo ""
          
          MISSING_SECRETS=()
          
          # Check KEYSTORE_BASE64
          if [ -z "$KEYSTORE_BASE64" ] || [ "$KEYSTORE_BASE64" = "null" ]; then
            MISSING_SECRETS+=("KEYSTORE_BASE64")
            echo "   ‚ùå KEYSTORE_BASE64: NOT SET"
          else
            echo "   ‚úÖ KEYSTORE_BASE64: SET (${#KEYSTORE_BASE64} characters)"
          fi
          
          # Check KEYSTORE_PASSWORD
          if [ -z "$KEYSTORE_PASSWORD" ] || [ "$KEYSTORE_PASSWORD" = "null" ]; then
            MISSING_SECRETS+=("KEYSTORE_PASSWORD")
            echo "   ‚ùå KEYSTORE_PASSWORD: NOT SET"
          else
            echo "   ‚úÖ KEYSTORE_PASSWORD: SET (hidden)"
          fi
          
          # Check KEY_ALIAS
          if [ -z "$KEY_ALIAS" ] || [ "$KEY_ALIAS" = "null" ]; then
            MISSING_SECRETS+=("KEY_ALIAS")
            echo "   ‚ùå KEY_ALIAS: NOT SET"
          else
            echo "   ‚úÖ KEY_ALIAS: SET ($KEY_ALIAS)"
          fi
          
          # Check KEY_PASSWORD
          if [ -z "$KEY_PASSWORD" ] || [ "$KEY_PASSWORD" = "null" ]; then
            MISSING_SECRETS+=("KEY_PASSWORD")
            echo "   ‚ùå KEY_PASSWORD: NOT SET"
          else
            echo "   ‚úÖ KEY_PASSWORD: SET (hidden)"
          fi
          
          echo ""
          
          # Fail early if any secrets are missing
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "‚ùå ERROR: Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "üìã Solution:"
            echo "   This workflow uses the 'watomagic' environment."
            echo "   1. Go to: Settings ‚Üí Environments ‚Üí watomagic"
            echo "   2. Add missing secrets to the 'watomagic' environment"
            echo "   3. Required secrets: KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD"
            exit 1
          fi
          
          echo "‚úÖ All signing secrets verified successfully"

      # ============================================================
      # STEP 3: Create signing keystore file (EARLY - before heavy setup)
      # ============================================================
      - name: Create signing keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "üîê Creating keystore file from GitHub secret..."
          
          # Decode and create keystore
          echo "$KEYSTORE_BASE64" | base64 -d > watomagic-release.keystore
          
          # Verify keystore was created and is valid
          if [ ! -f "watomagic-release.keystore" ]; then
            echo "‚ùå ERROR: Failed to create keystore file"
            exit 1
          fi
          
          KEYSTORE_SIZE=$(stat -c%s watomagic-release.keystore 2>/dev/null || echo "0")
          if [ "$KEYSTORE_SIZE" -lt 100 ]; then
            echo "‚ùå ERROR: Keystore file too small ($KEYSTORE_SIZE bytes) - base64 decode may have failed"
            echo "   Verify the KEYSTORE_BASE64 secret is correctly encoded"
            exit 1
          fi
          
          echo "‚úÖ Keystore file created successfully"
          echo "   - Size: $KEYSTORE_SIZE bytes"
          ls -lh watomagic-release.keystore

      # ============================================================
      # STEP 4: Setup Java with Gradle cache
      # ============================================================
      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'gradle'  # ‚úÖ Caches Gradle dependencies for faster builds

      # ============================================================
      # STEP 5: Setup Android SDK
      # ============================================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ============================================================
      # STEP 6: Cache Android SDK (additional optimization)
      # ============================================================
      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/cache
            ~/.android/licenses
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('**/build.gradle.kts', '**/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-
        # Note: android-actions/setup-android@v3 handles SDK caching internally
        # This cache is for additional Android-related files

      # ============================================================
      # STEP 7: Create local.properties with SDK path
      # ============================================================
      - name: Create local.properties
        run: |
          echo "‚úÖ Setting up Android SDK location..."
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          cat local.properties
          echo "‚úÖ local.properties configured"

      # ============================================================
      # STEP 8: Fix Gradle permissions
      # ============================================================
      - name: Fix gradlew permissions
        run: |
          echo "‚úÖ Setting execute permissions on gradlew..."
          chmod +x gradlew
          ls -la gradlew

      # ============================================================
      # STEP 9: Verify Java and Gradle environment
      # ============================================================
      - name: Verify Java and Gradle environment
        run: |
          echo "‚òï Java version:"
          java -version
          echo ""
          echo "üìç JAVA_HOME: $JAVA_HOME"
          echo "üìç ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo ""
          echo "üîß Gradle version:"
          ./gradlew --version --no-daemon
          echo ""
          echo "üìã Gradle projects:"
          ./gradlew projects --no-daemon

      # ============================================================
      # STEP 10: Verify import statements
      # ============================================================
      - name: Verify import statements
        run: |
          echo "üîç Verifying import statements in project..."
          echo ""
          
          # Make script executable
          chmod +x scripts/check_imports.sh
          
          # Run import verification (fails build if errors found)
          ./scripts/check_imports.sh
          
          echo "‚úÖ Import verification completed"

      # ============================================================
      # STEP 11: Run unit tests (non-blocking)
      # ============================================================
      - name: Run unit tests
        continue-on-error: true
        run: |
          echo "üß™ Running unit tests..."
          echo "‚ö†Ô∏è  Tests are non-blocking - failures will be logged but won't stop the build"
          
          ./gradlew test --no-daemon --stacktrace || {
            echo "‚ùå Unit tests failed, but continuing build process..."
            echo "üìã Check test reports in workflow logs for details"
          }
          
          if [ -d "app/build/reports/tests" ]; then
            echo "üìä Test reports generated:"
            find app/build/reports/tests -name "index.html" -type f
          fi
          
          echo "‚úÖ Unit test execution completed"

      # ============================================================
      # STEP 12: Run lint checks (non-blocking)
      # ============================================================
      - name: Run lint checks
        continue-on-error: true
        run: |
          echo "üîç Running Android lint checks..."
          echo "‚ö†Ô∏è  Lint is non-blocking - issues will be logged but won't stop the build"
          
          ./gradlew lintDefaultRelease --no-daemon --stacktrace || {
            echo "‚ö†Ô∏è  Lint found issues, but continuing build process..."
            echo "üìã Check lint reports in workflow logs for details"
          }
          
          if [ -f "app/build/reports/lint-results-DefaultRelease.html" ]; then
            echo "üìä Lint report generated: app/build/reports/lint-results-DefaultRelease.html"
          fi
          
          echo "‚úÖ Lint check completed"

      # ============================================================
      # STEP 13: Build signed Android Release APK
      # ============================================================
      - name: Build Android Release APK (SIGNED)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BASE_VERSION_CODE: ${{ env.BASE_VERSION_CODE }}
        run: |
          echo "üèóÔ∏è  Building SIGNED Android Release APK (Default flavor)..."
          
          # Calculate dynamic version code: BASE_VERSION_CODE + GitHub run number
          VERSION_CODE=$((BASE_VERSION_CODE + GITHUB_RUN_NUMBER))
          VERSION_NAME="1.$GITHUB_RUN_NUMBER"
          
          echo "üì¶ Version configuration:"
          echo "   - Version Code: $VERSION_CODE"
          echo "   - Version Name: $VERSION_NAME"
          echo "   - GitHub Run Number: $GITHUB_RUN_NUMBER"
          echo ""
          
          echo "üîê Signing configuration:"
          echo "   - Keystore: watomagic-release.keystore"
          echo "   - Key Alias: $KEY_ALIAS"
          echo ""
          
          echo "üöÄ Starting Gradle build with signing..."
          ./gradlew assembleDefaultRelease \
            -PversionCode=$VERSION_CODE \
            -PversionName=$VERSION_NAME \
            -Pandroid.injected.signing.store.file=$(pwd)/watomagic-release.keystore \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD \
            --no-daemon \
            --parallel \
            --stacktrace \
            --info
          
          echo "‚úÖ Gradle build command completed"

      # ============================================================
      # STEP 14: Validate APK build artifacts
      # ============================================================
      - name: Validate APK artifacts
        run: |
          echo "üîç Validating APK build artifacts..."
          
          APK_PATH="app/build/outputs/apk/Default/release/app-Default-release.apk"
          
          if [ -f "$APK_PATH" ]; then
            echo "‚úÖ SIGNED APK generated successfully!"
            echo ""
            echo "üì¶ APK Details:"
            echo "   - Path: $APK_PATH"
            
            # Get APK size (‚úÖ Fixed for Linux: stat -c%s)
            APK_SIZE=$(stat -c%s "$APK_PATH")
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
            echo "   - Size: $APK_SIZE bytes ($APK_SIZE_MB MB)"
            
            # Verify APK is not empty
            if [ "$APK_SIZE" -gt 1000000 ]; then
              echo "   - Status: Valid (size > 1MB)"
            else
              echo "   - ‚ö†Ô∏è  Warning: APK size seems too small"
            fi
            
            echo ""
            echo "‚úÖ APK validation successful"
          else
            echo "‚ùå ERROR: APK not found at expected path!"
            echo "   Expected: $APK_PATH"
            echo ""
            echo "üìã Searching for APK files:"
            find app/build/outputs -name "*.apk" -type f || echo "No APK files found"
            exit 1
          fi

      # ============================================================
      # STEP 15: Upload APK as artifact
      # ============================================================
      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: watomagic-release-apk
          path: app/build/outputs/apk/Default/release/*.apk
          retention-days: 30

      # ============================================================
      # STEP 15b: Calculate version info for release
      # ============================================================
      - name: Calculate version info
        if: success() && startsWith(github.ref, 'refs/tags/v')
        id: version
        env:
          BASE_VERSION_CODE: ${{ env.BASE_VERSION_CODE }}
        run: |
          VERSION_CODE=$((BASE_VERSION_CODE + GITHUB_RUN_NUMBER))
          VERSION_NAME="1.$GITHUB_RUN_NUMBER"
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Version Code: $VERSION_CODE"
          echo "üì¶ Version Name: $VERSION_NAME"

      # ============================================================
      # STEP 15c: Rename APK with tag name (only for tags v*)
      # ============================================================
      - name: Rename APK for release
        if: success() && startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "üìù Renaming APK with tag name..."
          
          ORIGINAL_APK="app/build/outputs/apk/Default/release/app-Default-release.apk"
          TAG_NAME="${{ github.ref_name }}"
          NEW_APK_NAME="watomagic-${TAG_NAME}.apk"
          NEW_APK_PATH="app/build/outputs/apk/Default/release/${NEW_APK_NAME}"
          
          if [ -f "$ORIGINAL_APK" ]; then
            cp "$ORIGINAL_APK" "$NEW_APK_PATH"
            echo "‚úÖ APK renamed successfully:"
            echo "   - Original: $ORIGINAL_APK"
            echo "   - New: $NEW_APK_PATH"
            echo "   - Tag: $TAG_NAME"
            echo "NEW_APK_PATH=$NEW_APK_PATH" >> $GITHUB_ENV
            echo "NEW_APK_NAME=$NEW_APK_NAME" >> $GITHUB_ENV
          else
            echo "‚ùå ERROR: Original APK not found at $ORIGINAL_APK"
            exit 1
          fi

      # ============================================================
      # STEP 15d: Create GitHub Release and upload APK (only for tags v*)
      # ============================================================
      - name: Create GitHub Release
        if: success() && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Watomagic ${{ github.ref_name }}
            
            ### üì¶ APK Download
            - **Default (F-Droid variant)**: `${{ env.NEW_APK_NAME }}`
            
            ### üîê Build Information
            - **Version Code**: ${{ steps.version.outputs.version_code }}
            - **Version Name**: ${{ steps.version.outputs.version_name }}
            - **Build Type**: Release (SIGNED)
            - **Flavor**: Default
            - **Package**: ${{ env.PACKAGE_NAME }}
            
            ### üìã Installation
            1. Download the APK from the assets below
            2. Enable "Install from unknown sources" on your Android device
            3. Install using: `adb install -r ${{ env.NEW_APK_NAME }}`
            
            ---
            *This release was automatically created from tag ${{ github.ref_name }}*
          files: |
            ${{ env.NEW_APK_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: true

      # ============================================================
      # STEP 16: Upload test reports
      # ============================================================
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            app/build/reports/tests/**/*
            app/build/reports/lint-*.html
          retention-days: 30

      # ============================================================
      # STEP 17: Build summary
      # ============================================================
      - name: Build summary
        if: always()
        env:
          BASE_VERSION_CODE: ${{ env.BASE_VERSION_CODE }}
          PACKAGE_NAME: ${{ env.PACKAGE_NAME }}
        run: |
          echo "======================================"
          echo "üì± WATOMAGIC BUILD SUMMARY"
          echo "======================================"
          echo ""
          echo "‚úÖ Build Type: Release (SIGNED)"
          echo "‚úÖ Flavor: Default (F-Droid variant)"
          echo "‚úÖ Application ID: $PACKAGE_NAME"
          echo "‚úÖ Version Code: $((BASE_VERSION_CODE + GITHUB_RUN_NUMBER))"
          echo "‚úÖ Version Name: 1.$GITHUB_RUN_NUMBER"
          echo "‚úÖ Signing: ENABLED"
          echo "‚úÖ Runner: ubuntu-latest (Linux - faster & free)"
          echo ""
          echo "üì¶ Artifacts:"
          echo "   - APK: app-Default-release.apk (SIGNED)"
          echo "   - Location: app/build/outputs/apk/Default/release/"
          echo "   - Downloads: Available in GitHub Actions > Artifacts"
          echo ""
          echo "üéØ Next Steps:"
          echo "   1. Download the SIGNED APK from GitHub Actions artifacts"
          echo "   2. Upload to Google Play Console (Internal/Alpha/Beta testing)"
          echo "   3. Install on test devices (adb install -r <apk>)"
          echo ""
          echo "======================================"

      # ============================================================
      # STEP 18: Notify on failure (optional)
      # ============================================================
      - name: Notify build failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Only create comment if this is a PR
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚ùå Build failed! Check the workflow logs for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
              });
            }

